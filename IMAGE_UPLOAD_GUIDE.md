# 🖼️ Руководство по загрузке изображений и номерам заказов

## ✅ Что было реализовано

### 1. **Исправлена раздача статических файлов**
- ✅ Добавлена раздача файлов из `/attached_assets`
- ✅ Изображения пицц теперь отображаются корректно
- ✅ URL: `http://localhost:5000/attached_assets/...`

### 2. **Система загрузки изображений**
- ✅ Установлен `multer` для загрузки файлов
- ✅ Создан endpoint `/api/upload`
- ✅ Автоматическое создание папки `attached_assets/uploads`
- ✅ Уникальные имена файлов (timestamp + random)
- ✅ Ограничение размера: 5MB
- ✅ Поддерживаемые форматы: JPEG, JPG, PNG, GIF, WEBP

### 3. **Загрузка в админ-панели**
- ✅ Кнопка "Upload" (Завантажити) в форме добавления/редактирования пиццы
- ✅ Предпросмотр загруженного изображения
- ✅ Можно вставить URL или загрузить файл
- ✅ Индикатор загрузки
- ✅ Toast уведомления об успехе/ошибке

### 4. **Номер заказа при оформлении**
- ✅ Генерируется автоматически (ID из базы данных)
- ✅ Отображается в красивом диалоге после оформления
- ✅ Отправляется в email через Formspree
- ✅ Двуязычный интерфейс (EN/UA)

---

## 📸 Система загрузки изображений

### Как работает:

1. **Пользователь загружает файл** в админ-панели
2. **Файл отправляется на сервер** через `/api/upload`
3. **Сервер сохраняет файл** в `attached_assets/uploads/`
4. **Генерируется уникальное имя**: `pizza-{timestamp}-{random}.{ext}`
5. **Возвращается URL**: `/attached_assets/uploads/pizza-...png`
6. **URL автоматически подставляется** в поле imageUrl

### Структура папок:

```
attached_assets/
├── generated_images/
│   ├── pizza_slice_icon.png  (текущее изображение для всех пицц)
│   └── ... (старые изображения)
└── uploads/  (новая папка для загруженных файлов)
    ├── pizza-1234567890-123456789.png
    ├── pizza-1234567891-987654321.jpg
    └── ...
```

### Технические детали:

**Endpoint:** `POST /api/upload`

**Параметры:**
- `image` (file) - изображение для загрузки

**Ответ:**
```json
{
  "imageUrl": "/attached_assets/uploads/pizza-1234567890-123456789.png"
}
```

**Ограничения:**
- Максимальный размер: 5MB
- Форматы: JPEG, JPG, PNG, GIF, WEBP
- Только изображения

**Код (server/routes.ts):**
```typescript
const upload = multer({ 
  storage: storageConfig,
  limits: { fileSize: 5 * 1024 * 1024 }, // 5MB
  fileFilter: (req, file, cb) => {
    const allowedTypes = /jpeg|jpg|png|gif|webp/;
    // ...
  }
});

app.post("/api/upload", upload.single('image'), (req, res) => {
  // ...
});
```

---

## 🔢 Номер заказа

### Как работает:

1. **Пользователь оформляет заказ**
2. **Заказ сохраняется в БД** с автоматическим ID
3. **ID возвращается** в ответе API
4. **Отображается диалог** с номером заказа
5. **Номер отправляется в email**

### Визуальное отображение:

```
┌─────────────────────────────┐
│           ✓                 │
│   Order Placed Successfully!│
│                             │
│  ┌─────────────────────┐   │
│  │   📦 Your Order     │   │
│  │      Number         │   │
│  │                     │   │
│  │       #42           │   │
│  └─────────────────────┘   │
│                             │
│  A confirmation email has   │
│  been sent...               │
│                             │
│  Thank you! 🍕              │
│                             │
│  [Back to Home]             │
└─────────────────────────────┘
```

### Email формат:

```
🍕 NEW ORDER #42

Customer: Иван Иванов
Email: ivan@example.com
Phone: +380123456789

Pizza: Margherita Classic
Size: medium
Total: $15.49

Delivery Address:
ул. Шевченко, 10, Киев

Order Number: #42
```

### Код (Checkout.tsx):

```typescript
const createOrderMutation = useMutation({
  mutationFn: async (data: OrderFormData) => {
    const dbResponse = await apiRequest('POST', '/api/orders', data);
    
    const emailData = {
      orderNumber: dbResponse.id,
      message: `🍕 NEW ORDER #${dbResponse.id}\n\n...`
    };
    
    await fetch('https://formspree.io/f/meorndkv', {
      method: 'POST',
      body: JSON.stringify(emailData),
    });
    
    return dbResponse;
  },
  onSuccess: (data) => {
    setOrderNumber(data.id);
    setShowSuccessDialog(true);
  }
});
```

---

## 🎯 Использование

### Загрузка изображения в админке:

1. Откройте админ-панель: http://localhost:5000/admin
2. Войдите (admin/admin123)
3. Нажмите "Add New Pizza"
4. Заполните поля
5. В поле "Image URL":
   - **Вариант 1:** Вставьте URL вручную
   - **Вариант 2:** Нажмите "Upload" (Завантажити)
6. Выберите файл с компьютера
7. Дождитесь загрузки
8. URL автоматически подставится
9. Увидите предпросмотр изображения
10. Нажмите "Save"

### Оформление заказа с номером:

1. Откройте http://localhost:5000/calculator
2. Выберите пиццу, размер, ингредиенты
3. Нажмите "Place Order"
4. Заполните форму с вашим email
5. Нажмите "Confirm Order"
6. Увидите диалог с номером заказа
7. Проверьте email - придет письмо с номером

---

## 📁 Файлы изменений

### Server:
- `server/routes.ts` - добавлена раздача статики и endpoint загрузки
- `package.json` - добавлены multer и @types/multer

### Client:
- `client/src/pages/Admin.tsx` - добавлена загрузка изображений
- `client/src/pages/Checkout.tsx` - добавлен номер заказа и диалог

### Новые папки:
- `attached_assets/uploads/` - папка для загруженных изображений

---

## 🔧 API Endpoints

### Загрузка изображения:
```
POST /api/upload
Content-Type: multipart/form-data

Body:
  image: [file]

Response:
{
  "imageUrl": "/attached_assets/uploads/pizza-1234567890-123456789.png"
}
```

### Создание заказа:
```
POST /api/orders
Content-Type: application/json

Body: {
  "customerName": "...",
  "customerEmail": "...",
  "customerPhone": "...",
  "deliveryAddress": "...",
  "pizzaId": 1,
  "size": "medium",
  "extraIngredients": "[]",
  "totalPrice": "15.49"
}

Response: {
  "id": 42,
  "customerName": "...",
  ...
}
```

### Раздача статики:
```
GET /attached_assets/generated_images/pizza_slice_icon.png
GET /attached_assets/uploads/pizza-1234567890-123456789.png
```

---

## 🎨 Особенности UI

### Админ-панель:

**Поле загрузки:**
```
┌─────────────────────────────────────┐
│ Image URL                           │
│ ┌─────────────────────┬──────────┐ │
│ │ /attached_assets... │ [Upload] │ │
│ └─────────────────────┴──────────┘ │
│                                     │
│ ┌─────────────────────────────────┐ │
│ │                                 │ │
│ │      [Image Preview]            │ │
│ │                                 │ │
│ └─────────────────────────────────┘ │
└─────────────────────────────────────┘
```

**Состояния кнопки:**
- Обычное: "Upload" / "Завантажити"
- Загрузка: "Uploading..." / "Завантаження..."
- Disabled во время загрузки

### Диалог заказа:

**Элементы:**
- ✓ Зеленая галочка в круге
- 📦 Иконка пакета
- Крупный номер заказа (#42)
- Описание о письме
- Благодарность с эмодзи
- Кнопка "Back to Home"

---

## 🚀 Проверка работы

### 1. Проверка раздачи изображений:
```bash
curl http://localhost:5000/attached_assets/generated_images/pizza_slice_icon.png
# Должен вернуть PNG файл
```

### 2. Проверка загрузки:
```bash
# В админке загрузите изображение
# Проверьте папку:
ls attached_assets/uploads/
# Должны появиться файлы pizza-*.png
```

### 3. Проверка номера заказа:
```bash
# Оформите заказ через сайт
# Проверьте:
# 1. Диалог с номером
# 2. Email с номером
# 3. БД (должен быть ID)
```

---

## 📊 Результаты

### До изменений:
- ❌ Изображения пицц не отображались
- ❌ Нельзя загрузить изображение через админку
- ❌ Нет номера заказа
- ❌ В email нет номера заказа

### После изменений:
- ✅ Изображения отображаются корректно
- ✅ Можно загружать изображения через админку
- ✅ Автоматическая генерация номера заказа
- ✅ Красивый диалог с номером
- ✅ Номер в email письме
- ✅ Предпросмотр изображения
- ✅ Валидация форматов и размера

---

## 💡 Советы

### Загрузка изображений:
1. Используйте изображения хорошего качества (минимум 800x600)
2. Оптимизируйте размер (не более 2-3MB)
3. Используйте JPEG для фотографий, PNG для графики
4. Квадратные изображения лучше всего подходят

### Номера заказов:
1. Номер генерируется автоматически
2. Номер уникальный для каждого заказа
3. Номер можно использовать для отслеживания
4. Сохраните номер для связи с поддержкой

---

## ✨ Итог

✅ **Все задачи выполнены:**
1. Изображения пицц отображаются корректно
2. Система загрузки изображений работает
3. Номер заказа генерируется и отображается
4. Номер отправляется в email
5. Красивый UI для всех функций

**Откройте http://localhost:5000 и проверьте все функции!** 🎉
